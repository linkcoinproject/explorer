<%- include('partials/header') %>

    <div class="transaction-detail-page">
        <div class="page-header">
            <div class="breadcrumb">
                <a href="/">Dashboard</a>
                <i class="fas fa-chevron-right"></i>
                <span>Transaction</span>
            </div>
            <h1><i class="fas fa-exchange-alt"></i> Transaction Details</h1>
        </div>

        <!-- Transaction Status Banner -->
        <div class="status-banner <%= tx.status && tx.status.confirmed ? 'confirmed' : 'pending' %>">
            <i class="fas <%= tx.status && tx.status.confirmed ? 'fa-check-circle' : 'fa-clock' %>"></i>
            <% if (tx.status && tx.status.confirmed) { %>
                Confirmed in block <a href="/block/<%= tx.status.block_hash %>">
                    <%= formatNumber(tx.status.block_height) %>
                </a>
                <% } else { %>
                    Pending confirmation
                    <% } %>
        </div>

        <!-- Transaction Details Card -->
        <div class="content-card">
            <div class="card-header">
                <h2>Transaction Information</h2>
                <button class="btn-toggle-raw" id="toggle-all-raw" onclick="toggleAllRaw()">
                    <i class="fas fa-code"></i> <span id="toggle-raw-text">Show Raw</span>
                </button>
            </div>

            <div class="detail-grid">
                <div class="detail-item full-width">
                    <span class="detail-label">Transaction ID</span>
                    <span class="detail-value hash-full">
                        <%= tx.txid %>
                            <button class="copy-btn" onclick="copyToClipboard('<%= tx.txid %>')" title="Copy">
                                <i class="fas fa-copy"></i>
                            </button>
                    </span>
                </div>

                <% if (tx.status && tx.status.confirmed) { %>
                    <div class="detail-item">
                        <span class="detail-label">Block Height</span>
                        <span class="detail-value">
                            <a href="/block/<%= tx.status.block_hash %>" class="block-height">
                                <%= formatNumber(tx.status.block_height) %>
                            </a>
                        </span>
                    </div>

                    <div class="detail-item">
                        <span class="detail-label">Block Time</span>
                        <span class="detail-value">
                            <%= formatDate(tx.status.block_time) %> <span class="text-muted">(<%=
                                        formatTimeAgo(tx.status.block_time) %>)</span>
                        </span>
                    </div>
                    <% } %>

                        <div class="detail-item">
                            <span class="detail-label">Size</span>
                            <span class="detail-value">
                                <%= formatBytes(tx.size || 0) %>
                            </span>
                        </div>

                        <div class="detail-item">
                            <span class="detail-label">Weight</span>
                            <span class="detail-value">
                                <%= formatNumber(tx.weight || 0) %>
                            </span>
                        </div>

                        <div class="detail-item">
                            <span class="detail-label">Version</span>
                            <span class="detail-value">
                                <%= tx.version %>
                            </span>
                        </div>

                        <div class="detail-item">
                            <span class="detail-label">Locktime</span>
                            <span class="detail-value">
                                <%= tx.locktime %>
                            </span>
                        </div>

                        <div class="detail-item">
                            <span class="detail-label">Fee</span>
                            <span class="detail-value highlight">
                                <%= tx.fee ? (tx.fee / 100000000).toFixed(8) : '0.00000000' %>
                                    <%= config.coinTicker %>
                            </span>
                        </div>

                        <div class="detail-item">
                            <span class="detail-label">Fee Rate</span>
                            <span class="detail-value">
                                <%= tx.fee && tx.size ? (tx.fee / tx.size).toFixed(2) : '0' %> sat/B
                            </span>
                        </div>
            </div>
        </div>

        <!-- Inputs and Outputs -->
        <div class="tx-io-container">
            <!-- Inputs -->
            <div class="content-card io-card">
                <div class="card-header">
                    <h2><i class="fas fa-sign-in-alt"></i> Inputs (<%= tx.vin.length %>)</h2>
                    <span class="io-total">
                        <%= (totalInput / 100000000).toFixed(8) %>
                            <%= config.coinTicker %>
                    </span>
                </div>

                <div class="io-list">
                    <% tx.vin.forEach(function(vin, index) { %>
                        <div class="io-item-detailed">
                            <div class="io-main">
                                <div class="io-index">#<%= index %>
                                </div>
                                <div class="io-content">
                                    <% if (vin.is_coinbase) { %>
                                        <div class="io-address coinbase">
                                            <i class="fas fa-gem"></i> Coinbase (New coins)
                                        </div>
                                        <div class="io-amount highlight">
                                            + <%= (totalOutput / 100000000).toFixed(8) %>
                                                <%= config.coinTicker %>
                                        </div>
                                        <% } else { %>
                                            <div class="io-address">
                                                <% if (vin.prevout && vin.prevout.scriptpubkey_address) { %>
                                                    <a href="/address/<%= vin.prevout.scriptpubkey_address %>">
                                                        <%= vin.prevout.scriptpubkey_address %>
                                                    </a>
                                                    <% } else { %>
                                                        <span class="text-muted">Unknown</span>
                                                        <% } %>
                                            </div>
                                            <div class="io-amount">
                                                <%= vin.prevout && vin.prevout.value ? (vin.prevout.value /
                                                    100000000).toFixed(8) : '0.00000000' %>
                                                    <%= config.coinTicker %>
                                            </div>
                                            <div class="io-txref">
                                                <a href="/tx/<%= vin.txid %>" class="text-muted">
                                                    <%= formatHash(vin.txid, 16) %>:<%= vin.vout %>
                                                </a>
                                            </div>
                                            <% } %>
                                </div>
                            </div>

                            <!-- Raw Data (Expandable) -->
                            <div class="io-raw-data">
                                <div class="raw-section">
                                    <h5>Input Details</h5>
                                    <div class="raw-grid">
                                        <% if (vin.is_coinbase) { %>
                                            <div class="raw-item">
                                                <span class="raw-label">Type</span>
                                                <span class="raw-value">Coinbase</span>
                                            </div>
                                            <div class="raw-item full-width">
                                                <span class="raw-label">Coinbase Data (Hex)</span>
                                                <span class="raw-value mono expandable">
                                                    <%= vin.scriptsig || 'N/A' %>
                                                </span>
                                            </div>
                                            <% } else { %>
                                                <div class="raw-item full-width">
                                                    <span class="raw-label">Previous TX</span>
                                                    <span class="raw-value mono">
                                                        <a href="/tx/<%= vin.txid %>">
                                                            <%= vin.txid %>
                                                        </a>
                                                    </span>
                                                </div>
                                                <div class="raw-item">
                                                    <span class="raw-label">Output Index (vout)</span>
                                                    <span class="raw-value">
                                                        <%= vin.vout %>
                                                    </span>
                                                </div>
                                                <div class="raw-item">
                                                    <span class="raw-label">Sequence</span>
                                                    <span class="raw-value mono">
                                                        <%= vin.sequence %>
                                                    </span>
                                                </div>
                                                <% if (vin.scriptsig) { %>
                                                    <div class="raw-item full-width">
                                                        <span class="raw-label">ScriptSig (Hex)</span>
                                                        <span class="raw-value mono expandable">
                                                            <%= vin.scriptsig %>
                                                        </span>
                                                    </div>
                                                    <% } %>
                                                        <% if (vin.scriptsig_asm) { %>
                                                            <div class="raw-item full-width">
                                                                <span class="raw-label">ScriptSig (ASM)</span>
                                                                <span class="raw-value mono expandable">
                                                                    <%= vin.scriptsig_asm %>
                                                                </span>
                                                            </div>
                                                            <% } %>
                                                                <% if (vin.witness && vin.witness.length> 0) { %>
                                                                    <div class="raw-item full-width">
                                                                        <span class="raw-label">Witness</span>
                                                                        <span class="raw-value mono expandable">
                                                                            <%= JSON.stringify(vin.witness) %>
                                                                        </span>
                                                                    </div>
                                                                    <% } %>
                                                                        <% } %>
                                    </div>
                                </div>

                                <% if (vin.prevout) { %>
                                    <div class="raw-section">
                                        <h5>Previous Output Details</h5>
                                        <div class="raw-grid">
                                            <div class="raw-item full-width">
                                                <span class="raw-label">Address</span>
                                                <span class="raw-value mono">
                                                    <% if (vin.prevout.scriptpubkey_address) { %>
                                                        <a href="/address/<%= vin.prevout.scriptpubkey_address %>">
                                                            <%= vin.prevout.scriptpubkey_address %>
                                                        </a>
                                                        <% } else { %>
                                                            N/A
                                                            <% } %>
                                                </span>
                                            </div>
                                            <div class="raw-item">
                                                <span class="raw-label">Value</span>
                                                <span class="raw-value">
                                                    <%= vin.prevout.value ? (vin.prevout.value / 100000000).toFixed(8)
                                                        : '0' %>
                                                        <%= config.coinTicker %>
                                                </span>
                                            </div>
                                            <div class="raw-item">
                                                <span class="raw-label">Script Type</span>
                                                <span class="raw-value">
                                                    <%= vin.prevout.scriptpubkey_type || 'Unknown' %>
                                                </span>
                                            </div>
                                            <% if (vin.prevout.scriptpubkey) { %>
                                                <div class="raw-item full-width">
                                                    <span class="raw-label">ScriptPubKey (Hex)</span>
                                                    <span class="raw-value mono expandable">
                                                        <%= vin.prevout.scriptpubkey %>
                                                    </span>
                                                </div>
                                                <% } %>
                                                    <% if (vin.prevout.scriptpubkey_asm) { %>
                                                        <div class="raw-item full-width">
                                                            <span class="raw-label">ScriptPubKey (ASM)</span>
                                                            <span class="raw-value mono expandable">
                                                                <%= vin.prevout.scriptpubkey_asm %>
                                                            </span>
                                                        </div>
                                                        <% } %>
                                        </div>
                                    </div>
                                    <% } %>
                            </div>
                        </div>
                        <% }); %>
                </div>
            </div>

            <div class="io-arrow">
                <i class="fas fa-arrow-right"></i>
            </div>

            <!-- Outputs -->
            <div class="content-card io-card">
                <div class="card-header">
                    <h2><i class="fas fa-sign-out-alt"></i> Outputs (<%= tx.vout.length %>)</h2>
                    <span class="io-total">
                        <%= (totalOutput / 100000000).toFixed(8) %>
                            <%= config.coinTicker %>
                    </span>
                </div>

                <div class="io-list">
                    <% tx.vout.forEach(function(vout, index) { %>
                        <div class="io-item-detailed">
                            <div class="io-main">
                                <div class="io-index">#<%= index %>
                                </div>
                                <div class="io-content">
                                    <div class="io-address">
                                        <% if (vout.scriptpubkey_address) { %>
                                            <a href="/address/<%= vout.scriptpubkey_address %>">
                                                <%= vout.scriptpubkey_address %>
                                            </a>
                                            <% } else { %>
                                                <span class="text-muted">
                                                    <%= vout.scriptpubkey_type || 'Unknown' %>
                                                </span>
                                                <% } %>
                                    </div>
                                    <div class="io-amount">
                                        <%= vout.value ? (vout.value / 100000000).toFixed(8) : '0.00000000' %>
                                            <%= config.coinTicker %>
                                    </div>
                                </div>
                            </div>

                            <!-- Raw Data (Expandable) -->
                            <div class="io-raw-data">
                                <div class="raw-section">
                                    <h5>Output Details</h5>
                                    <div class="raw-grid">
                                        <div class="raw-item">
                                            <span class="raw-label">Index (n)</span>
                                            <span class="raw-value">
                                                <%= index %>
                                            </span>
                                        </div>
                                        <div class="raw-item">
                                            <span class="raw-label">Value</span>
                                            <span class="raw-value">
                                                <%= vout.value ? (vout.value / 100000000).toFixed(8) : '0' %>
                                                    <%= config.coinTicker %>
                                            </span>
                                        </div>
                                        <div class="raw-item">
                                            <span class="raw-label">Value (satoshis)</span>
                                            <span class="raw-value mono">
                                                <%= vout.value || 0 %>
                                            </span>
                                        </div>
                                        <div class="raw-item">
                                            <span class="raw-label">Script Type</span>
                                            <span class="raw-value">
                                                <%= vout.scriptpubkey_type || 'Unknown' %>
                                            </span>
                                        </div>
                                        <% if (vout.scriptpubkey_address) { %>
                                            <div class="raw-item full-width">
                                                <span class="raw-label">Address</span>
                                                <span class="raw-value mono">
                                                    <a href="/address/<%= vout.scriptpubkey_address %>">
                                                        <%= vout.scriptpubkey_address %>
                                                    </a>
                                                </span>
                                            </div>
                                            <% } %>
                                                <% if (vout.scriptpubkey) { %>
                                                    <div class="raw-item full-width">
                                                        <span class="raw-label">ScriptPubKey (Hex)</span>
                                                        <span class="raw-value mono expandable">
                                                            <%= vout.scriptpubkey %>
                                                        </span>
                                                    </div>
                                                    <% } %>
                                                        <% if (vout.scriptpubkey_asm) { %>
                                                            <div class="raw-item full-width">
                                                                <span class="raw-label">ScriptPubKey (ASM)</span>
                                                                <span class="raw-value mono expandable">
                                                                    <%= vout.scriptpubkey_asm %>
                                                                </span>
                                                            </div>
                                                            <% } %>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <% }); %>
                </div>
            </div>
        </div>
    </div>

    <style>
        /* IO Items */
        .io-item-detailed {
            border: 1px solid var(--border-color);
            border-radius: 6px;
            margin-bottom: 0.5rem;
            overflow: hidden;
        }

        .io-main {
            display: flex;
            gap: 0.75rem;
            padding: 0.75rem;
        }

        .io-index {
            color: var(--text-secondary);
            font-size: 0.8rem;
            min-width: 2rem;
        }

        .io-content {
            flex: 1;
        }

        .io-address {
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.85rem;
            word-break: break-all;
        }

        .io-address a {
            color: var(--info);
            text-decoration: none;
        }

        .io-address a:hover {
            text-decoration: underline;
        }

        .io-address.coinbase {
            color: var(--primary);
        }

        .io-amount {
            font-size: 0.85rem;
            color: var(--text-primary);
            margin-top: 0.25rem;
        }

        .io-amount.highlight {
            color: var(--success);
            font-weight: 600;
        }

        .io-txref {
            font-size: 0.75rem;
            margin-top: 0.25rem;
        }

        /* Raw Data Section - Hidden by default */
        .io-raw-data {
            display: none;
            background: var(--bg-card-hover);
            border-top: 1px solid var(--border-color);
            padding: 1rem;
        }

        /* Show raw data when body has show-raw class */
        body.show-raw .io-raw-data {
            display: block;
        }

        .raw-section {
            margin-bottom: 1rem;
        }

        .raw-section:last-child {
            margin-bottom: 0;
        }

        .raw-section h5 {
            margin: 0 0 0.75rem 0;
            color: var(--primary);
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .raw-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.75rem;
        }

        @media (max-width: 768px) {
            .raw-grid {
                grid-template-columns: 1fr;
            }
        }

        .raw-item {
            background: var(--bg-input);
            border-radius: 4px;
            padding: 0.75rem;
        }

        .raw-item.full-width {
            grid-column: 1 / -1;
        }

        .raw-label {
            display: block;
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-bottom: 0.25rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .raw-value {
            display: block;
            font-size: 0.85rem;
            color: var(--text-primary);
            word-break: break-all;
        }

        .raw-value.mono {
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.8rem;
        }

        .raw-value.expandable {
            background: var(--bg-input);
            padding: 0.5rem;
            border-radius: 4px;
            margin-top: 0.25rem;
        }

        .raw-value a {
            color: var(--info);
            text-decoration: none;
        }

        .raw-value a:hover {
            text-decoration: underline;
        }

        /* Toggle Raw Button */
        .btn-toggle-raw {
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            padding: 0.5rem 1rem;
            background: rgba(90, 200, 250, 0.15);
            color: var(--info);
            border: 1px solid var(--info);
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s;
        }

        .btn-toggle-raw:hover {
            background: rgba(90, 200, 250, 0.25);
        }

        body.show-raw .btn-toggle-raw {
            background: var(--info);
            color: #fff;
        }

        /* IO Container */
        .tx-io-container {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 1.5rem;
            align-items: start;
            margin-top: 1.5rem;
        }

        @media (max-width: 992px) {
            .tx-io-container {
                grid-template-columns: 1fr;
            }

            .io-arrow {
                transform: rotate(90deg);
                justify-self: center;
            }
        }

        .io-arrow {
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary);
            font-size: 1.5rem;
            padding-top: 3rem;
        }

        .io-list {
            padding: 0.75rem;
        }

        .io-total {
            font-weight: 600;
            color: var(--primary);
        }
    </style>

    <script>
        let showRaw = false;

        function toggleAllRaw() {
            showRaw = !showRaw;
            const body = document.body;
            const btn = document.getElementById('toggle-all-raw');
            const text = document.getElementById('toggle-raw-text');

            if (showRaw) {
                body.classList.add('show-raw');
                text.textContent = 'Hide Raw';
            } else {
                body.classList.remove('show-raw');
                text.textContent = 'Show Raw';
            }
        }
    </script>

    <%- include('partials/footer') %>