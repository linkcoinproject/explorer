<%- include('partials/header') %>

    <div class="block-detail-page">
        <div class="page-header">
            <div class="breadcrumb">
                <a href="/">Dashboard</a>
                <i class="fas fa-chevron-right"></i>
                <span>Block <%= formatNumber(block.height) %></span>
            </div>
            <h1><i class="fas fa-cube"></i> Block <%= formatNumber(block.height) %>
            </h1>
        </div>

        <!-- Block Navigation -->
        <div class="block-nav">
            <% if (prevBlock) { %>
                <a href="/block/<%= prevBlock %>" class="block-nav-btn"><i class="fas fa-arrow-left"></i> Previous
                    Block</a>
                <% } else { %>
                    <span class="block-nav-btn disabled"><i class="fas fa-arrow-left"></i> Previous Block</span>
                    <% } %>

                        <% if (nextBlock) { %>
                            <a href="/block/<%= nextBlock %>" class="block-nav-btn">Next Block <i
                                    class="fas fa-arrow-right"></i></a>
                            <% } else { %>
                                <span class="block-nav-btn disabled">Next Block <i
                                        class="fas fa-arrow-right"></i></span>
                                <% } %>
        </div>

        <!-- Block Details Card -->
        <div class="content-card">
            <div class="card-header">
                <h2>Block Information</h2>
            </div>

            <div class="detail-grid">
                <div class="detail-item full-width">
                    <span class="detail-label">Block Hash</span>
                    <span class="detail-value hash-full">
                        <%= block.id %>
                            <button class="copy-btn" onclick="copyToClipboard('<%= block.id %>')" title="Copy">
                                <i class="fas fa-copy"></i>
                            </button>
                    </span>
                </div>

                <div class="detail-item">
                    <span class="detail-label">Height</span>
                    <span class="detail-value">
                        <%= formatNumber(block.height) %>
                    </span>
                </div>

                <div class="detail-item">
                    <span class="detail-label">Timestamp</span>
                    <span class="detail-value">
                        <%= formatDate(block.timestamp) %>
                            <span class="text-muted">(<%= formatTimeAgo(block.timestamp) %>)</span>
                    </span>
                </div>

                <div class="detail-item">
                    <span class="detail-label">Transactions</span>
                    <span class="detail-value">
                        <%= formatNumber(block.tx_count) %>
                    </span>
                </div>

                <div class="detail-item">
                    <span class="detail-label">Size</span>
                    <span class="detail-value">
                        <%= formatBytes(block.size) %>
                    </span>
                </div>

                <div class="detail-item">
                    <span class="detail-label">Weight</span>
                    <span class="detail-value">
                        <%= formatNumber(block.weight) %>
                    </span>
                </div>

                <div class="detail-item">
                    <span class="detail-label">Difficulty</span>
                    <span class="detail-value">
                        <%= block.difficulty ? block.difficulty.toLocaleString(undefined, {maximumFractionDigits: 2})
                            : '--' %>
                    </span>
                </div>

                <div class="detail-item">
                    <span class="detail-label">Bits</span>
                    <span class="detail-value">
                        <%= block.bits %>
                    </span>
                </div>

                <div class="detail-item">
                    <span class="detail-label">Nonce</span>
                    <span class="detail-value">
                        <%= formatNumber(block.nonce) %>
                    </span>
                </div>

                <div class="detail-item">
                    <span class="detail-label">Version</span>
                    <span class="detail-value">
                        <%= block.version %>
                    </span>
                </div>

                <div class="detail-item full-width">
                    <span class="detail-label">Merkle Root</span>
                    <span class="detail-value hash-full">
                        <%= block.merkle_root %>
                            <button class="copy-btn" onclick="copyToClipboard('<%= block.merkle_root %>')" title="Copy">
                                <i class="fas fa-copy"></i>
                            </button>
                    </span>
                </div>

                <% if (block.previousblockhash) { %>
                    <div class="detail-item full-width">
                        <span class="detail-label">Previous Block Hash</span>
                        <span class="detail-value hash-full">
                            <a href="/block/<%= block.previousblockhash %>">
                                <%= block.previousblockhash %>
                            </a>
                            <button class="copy-btn" onclick="copyToClipboard('<%= block.previousblockhash %>')"
                                title="Copy">
                                <i class="fas fa-copy"></i>
                            </button>
                        </span>
                    </div>
                    <% } %>
            </div>
        </div>

        <!-- Transactions in Block -->
        <div class="content-card">
            <div class="card-header">
                <h2><i class="fas fa-exchange-alt"></i> Transactions (<%= formatNumber(block.tx_count) %>)</h2>
                <div class="header-actions">
                    <button class="btn-toggle-all" onclick="toggleAllTransactions()">
                        <i class="fas fa-expand-alt"></i> <span id="toggle-text">Expand All</span>
                    </button>
                    <span class="showing-info">Page <%= txPage + 1 %> of <%= totalTxPages %></span>
                </div>
            </div>

            <div class="tx-list">
                <% transactions.forEach(function(tx, txIndex) { // Calculate totals for this transaction let
                    totalInput=0, totalOutput=0; tx.vin.forEach(vin=> {
                    if (vin.prevout && vin.prevout.value) totalInput += vin.prevout.value;
                    });
                    tx.vout.forEach(vout => {
                    totalOutput += vout.value || 0;
                    });
                    const fee = tx.fee || (totalInput > 0 ? totalInput - totalOutput : 0);
                    const isCoinbase = tx.vin.length === 1 && tx.vin[0].is_coinbase;
                    %>
                    <div class="tx-item" data-index="<%= txIndex %>">
                        <!-- Transaction Header (Collapsed View) -->
                        <div class="tx-header" onclick="toggleTransaction(<%= txIndex %>)">
                            <div class="tx-header-left">
                                <% if (isCoinbase) { %>
                                    <span class="tx-badge coinbase"><i class="fas fa-gem"></i> Coinbase</span>
                                    <% } %>
                                        <span class="tx-hash" title="<%= tx.txid %>">
                                            <%= formatHash(tx.txid, 20) %>
                                        </span>
                                        <button class="copy-btn"
                                            onclick="event.stopPropagation(); copyToClipboard('<%= tx.txid %>')"
                                            title="Copy">
                                            <i class="fas fa-copy"></i>
                                        </button>
                            </div>
                            <div class="tx-header-right">
                                <span class="tx-amount">
                                    <%= (totalOutput / 100000000).toFixed(8) %>
                                        <%= config.coinTicker %>
                                </span>
                                <% if (!isCoinbase && fee> 0) { %>
                                    <span class="tx-fee">Fee: <%= (fee / 100000000).toFixed(8) %></span>
                                    <% } %>
                                        <i class="fas fa-chevron-down tx-expand-icon"></i>
                            </div>
                        </div>

                        <!-- Transaction Details (Expandable) -->
                        <div class="tx-details" id="tx-details-<%= txIndex %>">
                            <div class="tx-io-container">
                                <!-- Inputs -->
                                <div class="io-card">
                                    <div class="io-header">
                                        <h4><i class="fas fa-sign-in-alt"></i> Inputs (<%= tx.vin.length %>)</h4>
                                        <span class="io-total">
                                            <%= (totalInput / 100000000).toFixed(8) %>
                                                <%= config.coinTicker %>
                                        </span>
                                    </div>
                                    <div class="io-list">
                                        <% tx.vin.forEach(function(vin, index) { %>
                                            <div class="io-item">
                                                <div class="io-index">#<%= index %>
                                                </div>
                                                <div class="io-content">
                                                    <% if (vin.is_coinbase) { %>
                                                        <div class="io-address coinbase">
                                                            <i class="fas fa-gem"></i> Coinbase (New coins)
                                                        </div>
                                                        <div class="io-amount highlight">
                                                            + <%= (totalOutput / 100000000).toFixed(8) %>
                                                                <%= config.coinTicker %>
                                                        </div>
                                                        <% } else { %>
                                                            <div class="io-address">
                                                                <% if (vin.prevout && vin.prevout.scriptpubkey_address)
                                                                    { %>
                                                                    <a
                                                                        href="/address/<%= vin.prevout.scriptpubkey_address %>">
                                                                        <%= vin.prevout.scriptpubkey_address %>
                                                                    </a>
                                                                    <% } else { %>
                                                                        <span class="text-muted">Unknown</span>
                                                                        <% } %>
                                                            </div>
                                                            <div class="io-amount">
                                                                <%= vin.prevout && vin.prevout.value ?
                                                                    (vin.prevout.value / 100000000).toFixed(8)
                                                                    : '0.00000000' %>
                                                                    <%= config.coinTicker %>
                                                            </div>
                                                            <div class="io-txref">
                                                                <a href="/tx/<%= vin.txid %>" class="text-muted">
                                                                    <%= formatHash(vin.txid, 16) %>:<%= vin.vout %>
                                                                </a>
                                                            </div>
                                                            <% } %>
                                                </div>
                                            </div>
                                            <% }); %>
                                    </div>
                                </div>

                                <div class="io-arrow">
                                    <i class="fas fa-arrow-right"></i>
                                </div>

                                <!-- Outputs -->
                                <div class="io-card">
                                    <div class="io-header">
                                        <h4><i class="fas fa-sign-out-alt"></i> Outputs (<%= tx.vout.length %>)</h4>
                                        <span class="io-total">
                                            <%= (totalOutput / 100000000).toFixed(8) %>
                                                <%= config.coinTicker %>
                                        </span>
                                    </div>
                                    <div class="io-list">
                                        <% tx.vout.forEach(function(vout, index) { %>
                                            <div class="io-item">
                                                <div class="io-index">#<%= index %>
                                                </div>
                                                <div class="io-content">
                                                    <div class="io-address">
                                                        <% if (vout.scriptpubkey_address) { %>
                                                            <a href="/address/<%= vout.scriptpubkey_address %>">
                                                                <%= vout.scriptpubkey_address %>
                                                            </a>
                                                            <% } else { %>
                                                                <span class="text-muted">
                                                                    <%= vout.scriptpubkey_type || 'Unknown' %>
                                                                </span>
                                                                <% } %>
                                                    </div>
                                                    <div class="io-amount">
                                                        <%= vout.value ? (vout.value / 100000000).toFixed(8)
                                                            : '0.00000000' %>
                                                            <%= config.coinTicker %>
                                                    </div>
                                                </div>
                                            </div>
                                            <% }); %>
                                    </div>
                                </div>
                            </div>

                            <!-- Transaction Footer -->
                            <div class="tx-footer">
                                <div class="tx-meta">
                                    <span><i class="fas fa-weight-hanging"></i> Size: <%= formatBytes(tx.size || 0) %>
                                    </span>
                                    <% if (tx.weight) { %>
                                        <span><i class="fas fa-balance-scale"></i> Weight: <%= formatNumber(tx.weight)
                                                %></span>
                                        <% } %>
                                            <% if (!isCoinbase && fee> 0) { %>
                                                <span><i class="fas fa-coins"></i> Fee: <%= (fee / 100000000).toFixed(8)
                                                        %>
                                                        <%= config.coinTicker %></span>
                                                <span><i class="fas fa-tachometer-alt"></i> Fee Rate: <%= tx.size ? (fee
                                                        / tx.size).toFixed(2) : '0' %> sat/B</span>
                                                <% } %>
                                </div>
                                <a href="/tx/<%= tx.txid %>" class="btn-view-tx">
                                    <i class="fas fa-external-link-alt"></i> View Full Details
                                </a>
                            </div>
                        </div>
                    </div>
                    <% }); %>
            </div>

            <!-- Transaction Pagination -->
            <% if (totalTxPages> 1) { %>
                <div class="pagination">
                    <a href="/block/<%= block.id %>?txPage=<%= txPage - 1 %>"
                        class="page-btn <%= txPage <= 0 ? 'disabled' : '' %>">
                        <i class="fas fa-chevron-left"></i> Previous
                    </a>
                    <span class="page-info">Page <%= txPage + 1 %> of <%= totalTxPages %></span>
                    <a href="/block/<%= block.id %>?txPage=<%= txPage + 1 %>"
                        class="page-btn <%= txPage >= totalTxPages - 1 ? 'disabled' : '' %>">
                        Next <i class="fas fa-chevron-right"></i>
                    </a>
                </div>
                <% } %>
        </div>
    </div>

    <style>
        /* Transaction List */
        .tx-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .tx-item {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .tx-item:hover {
            border-color: var(--primary);
        }

        .tx-item.expanded {
            border-color: var(--primary);
            box-shadow: 0 4px 20px var(--primary-glow);
        }

        /* Transaction Header */
        .tx-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.25rem;
            cursor: pointer;
            transition: background 0.2s;
        }

        .tx-header:hover {
            background: var(--bg-card-hover);
        }

        .tx-header-left {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .tx-header-right {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .tx-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .tx-badge.coinbase {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: #000;
        }

        .tx-hash {
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.9rem;
            color: var(--info);
        }

        .tx-amount {
            font-weight: 600;
            color: var(--primary);
        }

        .tx-fee {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .tx-expand-icon {
            transition: transform 0.3s ease;
            color: var(--text-secondary);
        }

        .tx-item.expanded .tx-expand-icon {
            transform: rotate(180deg);
        }

        /* Transaction Details */
        .tx-details {
            display: none;
            border-top: 1px solid var(--border-color);
            padding: 1.25rem;
            background: var(--bg-card-hover);
        }

        .tx-item.expanded .tx-details {
            display: block;
        }

        .tx-io-container {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 1rem;
            align-items: start;
        }

        @media (max-width: 768px) {
            .tx-io-container {
                grid-template-columns: 1fr;
            }

            .io-arrow {
                transform: rotate(90deg);
                justify-self: center;
            }
        }

        .io-card {
            background: var(--bg-card);
            border-radius: 6px;
            border: 1px solid var(--border-color);
        }

        .io-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        .io-header h4 {
            margin: 0;
            font-size: 0.9rem;
            color: var(--text-primary);
        }

        .io-total {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--primary);
        }

        .io-list {
            padding: 0.5rem;
        }

        .io-item {
            display: flex;
            gap: 0.75rem;
            padding: 0.5rem;
            border-radius: 4px;
        }

        .io-item:hover {
            background: var(--bg-card-hover);
        }

        .io-index {
            color: var(--text-secondary);
            font-size: 0.8rem;
            min-width: 2rem;
        }

        .io-content {
            flex: 1;
        }

        .io-address {
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.85rem;
            word-break: break-all;
        }

        .io-address a {
            color: var(--info);
            text-decoration: none;
        }

        .io-address a:hover {
            text-decoration: underline;
        }

        .io-address.coinbase {
            color: var(--primary);
        }

        .io-amount {
            font-size: 0.85rem;
            color: var(--text-primary);
            margin-top: 0.25rem;
        }

        .io-amount.highlight {
            color: var(--success);
            font-weight: 600;
        }

        .io-txref {
            font-size: 0.75rem;
            margin-top: 0.25rem;
        }

        .io-arrow {
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary);
            font-size: 1.5rem;
            padding-top: 2rem;
        }

        /* Transaction Footer */
        .tx-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border-color);
        }

        .tx-meta {
            display: flex;
            gap: 1.5rem;
            flex-wrap: wrap;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .tx-meta span {
            display: flex;
            align-items: center;
            gap: 0.4rem;
        }

        .btn-view-tx {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: var(--primary);
            color: #000;
            border-radius: 6px;
            text-decoration: none;
            font-weight: 600;
            font-size: 0.85rem;
            transition: all 0.2s;
        }

        .btn-view-tx:hover {
            filter: brightness(1.1);
            color: #000;
        }

        /* Toggle All Button */
        .header-actions {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .btn-toggle-all {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: rgba(90, 200, 250, 0.15);
            color: var(--info);
            border: 1px solid var(--info);
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s;
        }

        .btn-toggle-all:hover {
            background: rgba(90, 200, 250, 0.25);
        }

        .btn-toggle-all.expanded {
            background: var(--info);
            color: #fff;
        }
    </style>

    <script>
        let allExpanded = false;

        function toggleTransaction(index) {
            const txItem = document.querySelector(`.tx-item[data-index="${index}"]`);
            txItem.classList.toggle('expanded');
            updateToggleButton();
        }

        function toggleAllTransactions() {
            const txItems = document.querySelectorAll('.tx-item');
            allExpanded = !allExpanded;

            txItems.forEach(item => {
                if (allExpanded) {
                    item.classList.add('expanded');
                } else {
                    item.classList.remove('expanded');
                }
            });

            updateToggleButton();
        }

        function updateToggleButton() {
            const txItems = document.querySelectorAll('.tx-item');
            const expandedCount = document.querySelectorAll('.tx-item.expanded').length;
            const toggleBtn = document.querySelector('.btn-toggle-all');
            const toggleText = document.getElementById('toggle-text');

            if (expandedCount === txItems.length) {
                allExpanded = true;
                toggleBtn.classList.add('expanded');
                toggleText.textContent = 'Collapse All';
                toggleBtn.querySelector('i').className = 'fas fa-compress-alt';
            } else if (expandedCount === 0) {
                allExpanded = false;
                toggleBtn.classList.remove('expanded');
                toggleText.textContent = 'Expand All';
                toggleBtn.querySelector('i').className = 'fas fa-expand-alt';
            } else {
                toggleBtn.classList.remove('expanded');
                toggleText.textContent = 'Expand All';
                toggleBtn.querySelector('i').className = 'fas fa-expand-alt';
            }
        }
    </script>

    <%- include('partials/footer') %>