<%- include('partials/header') %>

    <div class="statistics-page">
        <div class="page-header">
            <h1><i class="fas fa-chart-bar"></i> Network Statistics</h1>
            <p class="page-subtitle">Comprehensive analytics and insights into the <%= config.coinName %> blockchain</p>
        </div>

        <!-- Main Stats -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-header">
                    <span class="stat-label">CURRENT HEIGHT</span>
                    <i class="fas fa-cube stat-icon"></i>
                </div>
                <div class="stat-value">
                    <%= formatNumber(tipHeight) %>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-header">
                    <span class="stat-label">NETWORK HASHRATE</span>
                    <i class="fas fa-tachometer-alt stat-icon"></i>
                </div>
                <div class="stat-value">
                    <%= formatHashrate(hashrate) %>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-header">
                    <span class="stat-label">AVG BLOCK TIME</span>
                    <i class="fas fa-clock stat-icon"></i>
                </div>
                <div class="stat-value">
                    <%= avgBlockTime %>s
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-header">
                    <span class="stat-label">DIFFICULTY</span>
                    <i class="fas fa-mountain stat-icon"></i>
                </div>
                <div class="stat-value">
                    <%= formatDifficulty(difficulty) %>
                </div>
            </div>
        </div>

        <!-- Time Period Selector -->
        <div class="time-selector">
            <button class="time-btn active" data-period="7" onclick="changePeriod(7)">7 Days</button>
            <button class="time-btn" data-period="30" onclick="changePeriod(30)">30 Days</button>
            <button class="time-btn" data-period="90" onclick="changePeriod(90)">90 Days</button>
        </div>

        <!-- Charts Grid -->
        <div class="charts-grid">
            <!-- Daily Transaction Count -->
            <div class="content-card chart-card">
                <div class="card-header">
                    <h2><i class="fas fa-chart-line"></i> Daily Transaction Count</h2>
                </div>
                <div class="chart-container">
                    <canvas id="txCountChart"></canvas>
                </div>
            </div>

            <!-- Average Block Size -->
            <div class="content-card chart-card">
                <div class="card-header">
                    <h2><i class="fas fa-chart-bar"></i> Average Block Size</h2>
                </div>
                <div class="chart-container">
                    <canvas id="blockSizeChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Additional Stats -->
        <div class="content-card">
            <div class="card-header">
                <h2><i class="fas fa-info-circle"></i> Network Information</h2>
            </div>

            <div class="detail-grid">
                <div class="detail-item">
                    <span class="detail-label">Expected Block Time</span>
                    <span class="detail-value">
                        <%= config.blockTime %> seconds (<%= Math.round(config.blockTime / 60) %> minutes)
                    </span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Block Reward</span>
                    <span class="detail-value" id="block-reward-value">
                        <% if (blockReward> 0) { %>
                            <%= (blockReward / 100000000).toFixed(8) %>
                                <%= config.coinTicker %>
                                    <% } else { %>
                                        <span class="loading-text">Loading...</span>
                                        <% } %>
                    </span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Algorithm</span>
                    <span class="detail-value">
                        <%= config.algorithm %>
                    </span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Difficulty Adjustment</span>
                    <span class="detail-value">
                        <%= config.diffAdjustment %>
                    </span>
                </div>
            </div>
        </div>
    </div>

    <style>
        .time-selector {
            display: flex;
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-lg);
        }

        .time-btn {
            padding: 0.5rem 1rem;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            color: var(--text-secondary);
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .time-btn:hover {
            border-color: var(--primary);
            color: var(--text-primary);
        }

        .time-btn.active {
            background: var(--primary);
            border-color: var(--primary);
            color: #000;
            font-weight: 600;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: var(--spacing-lg);
            margin-bottom: var(--spacing-lg);
        }

        @media (max-width: 992px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }
        }

        .chart-card {
            margin-bottom: 0;
        }

        .chart-card .card-header h2 {
            font-size: 1rem;
        }

        .chart-container {
            height: 300px;
            padding: var(--spacing-md);
        }

        .loading-text {
            color: var(--text-secondary);
            font-style: italic;
        }
    </style>

    <script>
        const coinTicker = '<%= config.coinTicker %>';
        let currentPeriod = 7;
        let txCountChart = null;
        let blockSizeChart = null;

        // Chart.js theme colors
        function getChartColors() {
            const isDark = !document.documentElement.hasAttribute('data-theme') ||
                document.documentElement.getAttribute('data-theme') === 'dark';
            return {
                gridColor: isDark ? 'rgba(255,255,255,0.05)' : 'rgba(0,0,0,0.1)',
                textColor: isDark ? '#888' : '#444',
                primary: '#F5A623',
                primaryBg: 'rgba(245, 166, 35, 0.2)',
                secondary: '#5AC8FA',
                secondaryBg: 'rgba(90, 200, 250, 0.5)'
            };
        }

        // Format date for chart labels
        function formatChartDate(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleDateString(undefined, { month: 'short', day: 'numeric' });
        }

        // Format bytes short
        function formatBytesShort(bytes) {
            if (bytes >= 1024 * 1024) return (bytes / (1024 * 1024)).toFixed(1) + 'M';
            if (bytes >= 1024) return (bytes / 1024).toFixed(1) + 'K';
            return bytes + 'B';
        }

        // Initialize TX Count Chart
        function initTxCountChart(data) {
            const colors = getChartColors();
            const ctx = document.getElementById('txCountChart').getContext('2d');

            if (txCountChart) txCountChart.destroy();

            txCountChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => formatChartDate(d.date)),
                    datasets: [{
                        label: 'Transactions',
                        data: data.map(d => d.count),
                        fill: true,
                        backgroundColor: colors.primaryBg,
                        borderColor: colors.primary,
                        borderWidth: 2,
                        tension: 0.4,
                        pointRadius: data.length > 30 ? 0 : 4,
                        pointBackgroundColor: colors.primary
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: {
                            grid: { color: colors.gridColor },
                            ticks: {
                                color: colors.textColor,
                                maxTicksLimit: 7
                            }
                        },
                        y: {
                            grid: { color: colors.gridColor },
                            ticks: { color: colors.textColor },
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // Initialize Block Size Chart
        function initBlockSizeChart(data) {
            const colors = getChartColors();
            const ctx = document.getElementById('blockSizeChart').getContext('2d');

            if (blockSizeChart) blockSizeChart.destroy();

            blockSizeChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.map(d => formatChartDate(d.date)),
                    datasets: [{
                        label: 'Avg Block Size (bytes)',
                        data: data.map(d => d.avgSize),
                        backgroundColor: colors.secondaryBg,
                        borderColor: colors.secondary,
                        borderWidth: 1,
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: {
                            grid: { color: colors.gridColor },
                            ticks: {
                                color: colors.textColor,
                                maxTicksLimit: 7
                            }
                        },
                        y: {
                            grid: { color: colors.gridColor },
                            ticks: {
                                color: colors.textColor,
                                callback: function (value) {
                                    return formatBytesShort(value);
                                }
                            },
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // Change period and reload charts
        async function changePeriod(days) {
            currentPeriod = days;

            // Update button states
            document.querySelectorAll('.time-btn').forEach(btn => {
                btn.classList.toggle('active', parseInt(btn.dataset.period) === days);
            });

            try {
                // Fetch new data
                const [txResponse, sizeResponse] = await Promise.all([
                    fetch(`/api/stats/daily-tx?days=${days}`),
                    fetch(`/api/stats/block-size?days=${days}`)
                ]);

                const txData = await txResponse.json();
                const sizeData = await sizeResponse.json();

                // Update charts
                initTxCountChart(txData);
                initBlockSizeChart(sizeData);
            } catch (error) {
                console.error('Failed to fetch chart data:', error);
            }
        }

        // Fetch block reward if not loaded
        async function fetchBlockReward() {
            const rewardEl = document.getElementById('block-reward-value');
            if (rewardEl && rewardEl.querySelector('.loading-text')) {
                try {
                    const response = await fetch('/api/stats/block-reward');
                    const data = await response.json();
                    if (data.reward > 0) {
                        rewardEl.textContent = data.rewardCoins + ' ' + coinTicker;
                    } else {
                        rewardEl.textContent = 'Calculating...';
                    }
                } catch (e) {
                    rewardEl.textContent = 'N/A';
                }
            }
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function () {
            changePeriod(7);
            fetchBlockReward();
        });
    </script>

    <%- include('partials/footer') %>